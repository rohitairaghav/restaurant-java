<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <!-- Create recipes table for Restaurant Inventory Management -->

    <!-- Create recipes table -->
    <changeSet id="26-1" author="system" context="dev,staging,prod">
        <comment>Create recipes table with auto-increment ID and epoch timestamps</comment>
        <createTable tableName="recipes">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false" checkConstraint="CHECK (status IN ('Active', 'Disabled', 'Removed'))"/>
            </column>
            <column name="created_by" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_recipes_created_by" references="auth.users(id)"/>
            </column>
            <column name="updated_by" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_recipes_updated_by" references="auth.users(id)"/>
            </column>
            <column name="created_at" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="restaurant_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_recipes_restaurants" references="restaurants(id)"/>
            </column>
        </createTable>
        <rollback>
            <dropTable tableName="recipes"/>
        </rollback>
    </changeSet>

    <!-- Create index on restaurant_id for performance -->
    <changeSet id="26-2" author="system" context="dev,staging,prod">
        <comment>Create index on recipes.restaurant_id for query performance</comment>
        <createIndex tableName="recipes" indexName="idx_recipes_restaurant_id">
            <column name="restaurant_id"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="recipes" indexName="idx_recipes_restaurant_id"/>
        </rollback>
    </changeSet>

    <!-- Create index on status for filtering -->
    <changeSet id="26-3" author="system" context="dev,staging,prod">
        <comment>Create index on recipes.status for filtering by status</comment>
        <createIndex tableName="recipes" indexName="idx_recipes_status">
            <column name="status"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="recipes" indexName="idx_recipes_status"/>
        </rollback>
    </changeSet>

    <!-- Enable Row Level Security on recipes table -->
    <changeSet id="26-4" author="system" context="dev,staging,prod">
        <comment>Enable Row Level Security on recipes table</comment>
        <sql>
            ALTER TABLE recipes ENABLE ROW LEVEL SECURITY;
        </sql>
        <rollback>
            ALTER TABLE recipes DISABLE ROW LEVEL SECURITY;
        </rollback>
    </changeSet>

    <!-- Create RLS policies for recipes table -->
    <changeSet id="26-5" author="system" context="dev,staging,prod">
        <comment>Create RLS policies for recipes table (restaurant isolation)</comment>
        <sql>
            -- Users can access recipes from their own restaurant
            CREATE POLICY "Users access own restaurant recipes" ON recipes
                FOR ALL USING (
                    restaurant_id IN (
                        SELECT restaurant_id FROM user_profiles
                        WHERE id = auth.uid()
                    )
                );
        </sql>
        <rollback>
            DROP POLICY IF EXISTS "Users access own restaurant recipes" ON recipes;
        </rollback>
    </changeSet>

    <!-- Create GIN index on JSONB content for efficient querying -->
    <changeSet id="26-6" author="system" context="dev,staging,prod">
        <comment>Create GIN index on recipes.content JSONB column for efficient ingredient queries</comment>
        <sql>
            CREATE INDEX idx_recipes_content_gin ON recipes USING GIN (content);
        </sql>
        <rollback>
            DROP INDEX IF EXISTS idx_recipes_content_gin;
        </rollback>
    </changeSet>

</databaseChangeLog>
