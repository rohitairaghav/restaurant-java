<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <!-- Add cost field to stock_transactions table -->
    <changeSet id="25-add-cost-field-to-stock-transactions" author="system">
        <comment>Add cost field to stock_transactions table to track total cost per transaction</comment>

        <addColumn tableName="stock_transactions">
            <column name="cost" type="decimal(10,2)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn tableName="stock_transactions" columnName="cost"/>
        </rollback>
    </changeSet>

    <!-- Update the update_stock_transaction function to include cost parameter -->
    <changeSet id="25-update-stock-transaction-function-with-cost" author="system">
        <comment>Update the update_stock_transaction function to handle the cost field</comment>

        <sql splitStatements="false"><![CDATA[
            DROP FUNCTION IF EXISTS update_stock_transaction(UUID, UUID, VARCHAR(10), DECIMAL(10,2), VARCHAR(50), VARCHAR(100), TEXT);

            CREATE OR REPLACE FUNCTION update_stock_transaction(
              transaction_uuid UUID,
              new_item_id UUID,
              new_type VARCHAR(10),
              new_quantity DECIMAL(10,2),
              new_cost DECIMAL(10,2),
              new_reason VARCHAR(50),
              new_sku VARCHAR(100),
              new_notes TEXT
            )
            RETURNS TABLE(success BOOLEAN, message TEXT) AS $$
            DECLARE
              old_transaction stock_transactions%ROWTYPE;
              quantity_diff DECIMAL(10,2);
              stock_adjustment DECIMAL(10,2);
              current_stock_value DECIMAL(10,2);
              new_stock_value DECIMAL(10,2);
            BEGIN
              -- Validate inputs
              IF new_quantity IS NOT NULL AND new_quantity <= 0 THEN
                RETURN QUERY SELECT FALSE, 'Quantity must be greater than 0';
                RETURN;
              END IF;

              -- Get the old transaction
              SELECT * INTO old_transaction FROM stock_transactions WHERE id = transaction_uuid;

              IF NOT FOUND THEN
                RETURN QUERY SELECT FALSE, 'Transaction not found';
                RETURN;
              END IF;

              -- SECURITY: Verify user has access to this transaction (restaurant isolation)
              IF NOT EXISTS (
                SELECT 1 FROM stock_transactions
                WHERE id = transaction_uuid
                AND restaurant_id IN (
                  SELECT restaurant_id FROM user_profiles WHERE id = auth.uid()
                )
              ) THEN
                RETURN QUERY SELECT FALSE, 'Unauthorized: Cannot modify transactions from other restaurants';
                RETURN;
              END IF;

              -- SECURITY: Validate new_item_id belongs to same restaurant
              IF new_item_id IS NOT NULL AND new_item_id != old_transaction.item_id THEN
                IF NOT EXISTS (
                  SELECT 1 FROM inventory_items
                  WHERE id = new_item_id
                  AND restaurant_id = old_transaction.restaurant_id
                ) THEN
                  RETURN QUERY SELECT FALSE, 'Unauthorized: Item does not belong to this restaurant';
                  RETURN;
                END IF;
              END IF;

              -- Handle stock adjustments when quantity, item_id, or type changes
              IF COALESCE(new_quantity, old_transaction.quantity) != old_transaction.quantity OR
                 COALESCE(new_item_id, old_transaction.item_id) != old_transaction.item_id OR
                 COALESCE(new_type, old_transaction.type) != old_transaction.type THEN

                -- Step 1: Reverse the old transaction's effect on old item
                SELECT current_stock INTO current_stock_value
                FROM inventory_items
                WHERE id = old_transaction.item_id
                FOR UPDATE;

                -- Reverse old transaction
                stock_adjustment := CASE
                  WHEN old_transaction.type = 'in' THEN -old_transaction.quantity
                  ELSE old_transaction.quantity
                END;

                new_stock_value := current_stock_value + stock_adjustment;

                -- Prevent negative stock when reversing
                IF new_stock_value < 0 THEN
                  RETURN QUERY SELECT FALSE, 'Cannot reverse transaction: would result in negative stock';
                  RETURN;
                END IF;

                UPDATE inventory_items
                SET current_stock = new_stock_value
                WHERE id = old_transaction.item_id;

                -- Step 2: Apply the new transaction to the new item
                SELECT current_stock INTO current_stock_value
                FROM inventory_items
                WHERE id = COALESCE(new_item_id, old_transaction.item_id)
                FOR UPDATE;

                -- Apply new transaction
                stock_adjustment := CASE
                  WHEN COALESCE(new_type, old_transaction.type) = 'in' THEN COALESCE(new_quantity, old_transaction.quantity)
                  ELSE -COALESCE(new_quantity, old_transaction.quantity)
                END;

                new_stock_value := current_stock_value + stock_adjustment;

                -- Prevent negative stock
                IF new_stock_value < 0 THEN
                  RETURN QUERY SELECT FALSE, 'Update would result in negative stock for target item';
                  RETURN;
                END IF;

                UPDATE inventory_items
                SET current_stock = new_stock_value
                WHERE id = COALESCE(new_item_id, old_transaction.item_id);
              END IF;

              -- Update the transaction (use COALESCE to keep original values if null)
              UPDATE stock_transactions
              SET
                item_id = COALESCE(new_item_id, old_transaction.item_id),
                type = COALESCE(new_type, old_transaction.type),
                quantity = COALESCE(new_quantity, old_transaction.quantity),
                cost = COALESCE(new_cost, old_transaction.cost),
                reason = COALESCE(new_reason, old_transaction.reason),
                sku = COALESCE(new_sku, old_transaction.sku),
                notes = COALESCE(new_notes, old_transaction.notes)
              WHERE id = transaction_uuid;

              -- Check for low stock alerts
              PERFORM check_low_stock_alert(old_transaction.item_id);

              RETURN QUERY SELECT TRUE, 'Transaction updated successfully';
            END;
            $$ LANGUAGE plpgsql SECURITY DEFINER;
        ]]></sql>

        <rollback>
            <sql splitStatements="false"><![CDATA[
                DROP FUNCTION IF EXISTS update_stock_transaction(UUID, UUID, VARCHAR(10), DECIMAL(10,2), DECIMAL(10,2), VARCHAR(50), VARCHAR(100), TEXT);

            CREATE OR REPLACE FUNCTION update_stock_transaction(
              transaction_uuid UUID,
              new_item_id UUID,
              new_type VARCHAR(10),
              new_quantity DECIMAL(10,2),
              new_reason VARCHAR(50),
              new_sku VARCHAR(100),
              new_notes TEXT
            )
            RETURNS TABLE(success BOOLEAN, message TEXT) AS $$
            DECLARE
              old_transaction stock_transactions%ROWTYPE;
              quantity_diff DECIMAL(10,2);
              stock_adjustment DECIMAL(10,2);
              current_stock_value DECIMAL(10,2);
              new_stock_value DECIMAL(10,2);
            BEGIN
              -- Validate inputs
              IF new_quantity IS NOT NULL AND new_quantity <= 0 THEN
                RETURN QUERY SELECT FALSE, 'Quantity must be greater than 0';
                RETURN;
              END IF;

              -- Get the old transaction
              SELECT * INTO old_transaction FROM stock_transactions WHERE id = transaction_uuid;

              IF NOT FOUND THEN
                RETURN QUERY SELECT FALSE, 'Transaction not found';
                RETURN;
              END IF;

              -- Handle stock adjustments
              IF COALESCE(new_quantity, old_transaction.quantity) != old_transaction.quantity OR
                 COALESCE(new_item_id, old_transaction.item_id) != old_transaction.item_id OR
                 COALESCE(new_type, old_transaction.type) != old_transaction.type THEN

                SELECT current_stock INTO current_stock_value
                FROM inventory_items
                WHERE id = old_transaction.item_id
                FOR UPDATE;

                stock_adjustment := CASE
                  WHEN old_transaction.type = 'in' THEN -old_transaction.quantity
                  ELSE old_transaction.quantity
                END;

                new_stock_value := current_stock_value + stock_adjustment;

                IF new_stock_value < 0 THEN
                  RETURN QUERY SELECT FALSE, 'Cannot reverse transaction: would result in negative stock';
                  RETURN;
                END IF;

                UPDATE inventory_items
                SET current_stock = new_stock_value
                WHERE id = old_transaction.item_id;

                SELECT current_stock INTO current_stock_value
                FROM inventory_items
                WHERE id = COALESCE(new_item_id, old_transaction.item_id)
                FOR UPDATE;

                stock_adjustment := CASE
                  WHEN COALESCE(new_type, old_transaction.type) = 'in' THEN COALESCE(new_quantity, old_transaction.quantity)
                  ELSE -COALESCE(new_quantity, old_transaction.quantity)
                END;

                new_stock_value := current_stock_value + stock_adjustment;

                IF new_stock_value < 0 THEN
                  RETURN QUERY SELECT FALSE, 'Update would result in negative stock for target item';
                  RETURN;
                END IF;

                UPDATE inventory_items
                SET current_stock = new_stock_value
                WHERE id = COALESCE(new_item_id, old_transaction.item_id);
              END IF;

              UPDATE stock_transactions
              SET
                item_id = COALESCE(new_item_id, old_transaction.item_id),
                type = COALESCE(new_type, old_transaction.type),
                quantity = COALESCE(new_quantity, old_transaction.quantity),
                reason = COALESCE(new_reason, old_transaction.reason),
                sku = COALESCE(new_sku, old_transaction.sku),
                notes = COALESCE(new_notes, old_transaction.notes)
              WHERE id = transaction_uuid;

              PERFORM check_low_stock_alert(old_transaction.item_id);

              RETURN QUERY SELECT TRUE, 'Transaction updated successfully';
            END;
            $$ LANGUAGE plpgsql SECURITY DEFINER;
            ]]></sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
